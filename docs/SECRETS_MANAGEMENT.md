# Secrets Management Guide

This document explains how to configure and manage GitHub repository secrets for automated deployment of ImmoCalc.

## Overview

ImmoCalc uses GitHub Actions to automatically deploy to production servers. Sensitive configuration values (secrets) are stored in GitHub repository secrets and automatically injected into the deployment environment during the CI/CD process.

## Required Secrets

The following secrets must be configured in your GitHub repository settings (`Settings` → `Secrets and variables` → `Actions`):

### Deployment Infrastructure Secrets

These secrets are required for the GitHub Actions deployment workflow to connect to your server:

| Secret Name       | Description                                          | Example/Notes                           |
| ----------------- | ---------------------------------------------------- | --------------------------------------- |
| `SERVER_HOST`     | The IP address or hostname of your deployment server | `192.168.1.100` or `server.example.com` |
| `SERVER_USER`     | SSH username for server access                       | `deploy`                                |
| `SSH_PRIVATE_KEY` | Private SSH key for authentication                   | Generate with `ssh-keygen -t ed25519`   |
| `DOMAIN`          | Base domain for the deployment                       | `festas-builds.com`                     |

### Application Secrets

These secrets are used by the ImmoCalc application at runtime:

| Secret Name      | Description                                  | Required | How to Generate           |
| ---------------- | -------------------------------------------- | -------- | ------------------------- |
| `JWT_SECRET`     | Secret key for JWT token generation          | **Yes**  | `openssl rand -base64 32` |
| `SESSION_SECRET` | Secret key for session management (optional) | No       | `openssl rand -base64 32` |

**Notes:**

- `JWT_SECRET` is **required** for production deployments. Without it, authentication will fail.
- `SESSION_SECRET` is optional. If not provided, it defaults to `JWT_SECRET`.

## Setting Up Secrets

### 1. Generate Secret Values

Generate secure random values for your secrets:

```bash
# Generate JWT_SECRET
openssl rand -base64 32

# Generate SESSION_SECRET (optional)
openssl rand -base64 32

# Generate SSH key pair (if you don't have one)
ssh-keygen -t ed25519 -C "github-actions@immocalc" -f ~/.ssh/immocalc_deploy
```

### 2. Add Secrets to GitHub Repository

1. Navigate to your repository on GitHub
2. Click `Settings` → `Secrets and variables` → `Actions`
3. Click `New repository secret`
4. Enter the secret name and value
5. Click `Add secret`
6. Repeat for all required secrets

### 3. Configure Server SSH Access

On your deployment server, add the public key to authorized_keys:

```bash
# On your local machine, copy the public key
cat ~/.ssh/immocalc_deploy.pub

# On the deployment server, as the deploy user
mkdir -p ~/.ssh
chmod 700 ~/.ssh
echo "PASTE_PUBLIC_KEY_HERE" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
```

## How Secrets Are Used in Deployment

### Automated Injection Process

When you push code to the `main` branch or manually trigger a deployment:

1. **GitHub Actions Workflow Starts**: The `deploy.yml` workflow is triggered
2. **Docker Image Build**: Application is built into a Docker image and pushed to GitHub Container Registry
3. **SSH Connection**: GitHub Actions connects to your server using `SERVER_HOST`, `SERVER_USER`, and `SSH_PRIVATE_KEY`
4. **Environment File Creation**: A `.env` file is automatically created on the server with all secrets:
   ```bash
   # Auto-generated by GitHub Actions deployment
   NODE_ENV=production
   JWT_SECRET=<value from GitHub secret>
   SESSION_SECRET=<value from GitHub secret>
   DOMAIN=<value from GitHub secret>
   ```
5. **Docker Container Start**: Docker Compose loads the `.env` file and starts the application with the secrets as environment variables

### .env File Location

The `.env` file is created in the deployment directory on your server:

```
/home/deploy/immocalc/.env
```

**Important**: This file is automatically generated on each deployment. Do not edit it manually, as your changes will be overwritten.

## Health Check and Secret Verification

ImmoCalc includes a health check endpoint at `/api/health` that verifies all secrets are properly configured.

### Health Check Response

```json
{
  "status": "healthy|degraded|unhealthy",
  "timestamp": "2025-12-07T15:00:00.000Z",
  "checks": {
    "server": { "status": "up", "uptime": 12345 },
    "storage": { "status": "accessible", ... },
    "database": { "status": "accessible", ... },
    "secrets": {
      "status": "complete|partial|missing",
      "required": {
        "JWT_SECRET": true
      },
      "optional": {
        "SESSION_SECRET": true,
        "DOMAIN": true
      },
      "warnings": []
    }
  },
  "environment": {
    "nodeEnv": "production",
    "hasJwtSecret": true
  }
}
```

### Secret Status Meanings

- **`complete`**: All required and optional secrets are configured
- **`partial`**: Required secrets are present, but some optional secrets are missing
- **`missing`**: Required secrets (JWT_SECRET) are not configured

### Status Impact

| Secrets Status | Overall Health Status | Impact                                     |
| -------------- | --------------------- | ------------------------------------------ |
| `missing`      | `unhealthy` (503)     | Application will not function properly     |
| `partial`      | `degraded` (200)      | Application works but may have limitations |
| `complete`     | `healthy` (200)       | All features available                     |

### Warnings

When running in production mode, the health check will include warnings for missing secrets:

```json
{
  "warnings": [
    "JWT_SECRET is required in production for secure authentication",
    "SESSION_SECRET is recommended for enhanced security",
    "DOMAIN is recommended for proper production configuration"
  ]
}
```

## Troubleshooting

### Issue: Deployment fails with "JWT_SECRET not configured"

**Solution**: Ensure `JWT_SECRET` is added to GitHub repository secrets.

1. Go to repository Settings → Secrets and variables → Actions
2. Verify `JWT_SECRET` exists
3. If missing, add it with a value generated by `openssl rand -base64 32`
4. Trigger a new deployment

### Issue: Health check shows "unhealthy" status

**Solution**: Check the health endpoint response for details:

```bash
# On the server
curl http://localhost:3000/api/health | jq

# From external
curl https://immocalc.your-domain.com/api/health | jq
```

Look at the `checks.secrets` section to see which secrets are missing.

### Issue: Can't SSH to server during deployment

**Solution**: Verify SSH configuration:

1. Check that `SSH_PRIVATE_KEY` in GitHub secrets matches the public key on the server
2. Verify `SERVER_USER` has the correct permissions
3. Test SSH connection manually:
   ```bash
   ssh -i ~/.ssh/immocalc_deploy deploy@your-server-ip
   ```

### Issue: Secrets not updated after changing GitHub secret value

**Solution**: Trigger a new deployment:

1. Secrets are only updated during deployment
2. Either push a new commit to `main` branch
3. Or manually trigger deployment via GitHub Actions UI (Actions tab → Deploy to Hetzner → Run workflow)

## Best Practices

### Security

1. **Never commit secrets to version control**: Always use GitHub repository secrets
2. **Rotate secrets periodically**: Change JWT_SECRET and SESSION_SECRET every 90 days
3. **Use strong random values**: Always use cryptographically secure random generators like `openssl rand`
4. **Limit access**: Only give repository secret access to trusted team members
5. **Use separate secrets per environment**: Don't reuse production secrets in development

### Secret Rotation

To rotate secrets safely:

1. Generate new secret value: `openssl rand -base64 32`
2. Update GitHub repository secret with new value
3. Trigger new deployment
4. Old secret remains valid until deployment completes
5. After successful deployment, old secret is no longer used

### Monitoring

1. **Monitor health endpoint**: Set up monitoring to check `/api/health` regularly
2. **Alert on degraded status**: Configure alerts when secrets status is not "complete"
3. **Check deployment logs**: Review GitHub Actions logs for secret-related errors

## Adding New Secrets

When you need to add a new secret to the application:

### 1. Add to GitHub Repository

Add the secret value in GitHub repository settings.

### 2. Update Deployment Workflow

Edit `.github/workflows/deploy.yml`:

```yaml
- name: Deploy to server via SSH
  uses: appleboy/ssh-action@v1.0.3
  env:
    # ... existing env vars ...
    NEW_SECRET: ${{ secrets.NEW_SECRET }} # Add here
  with:
    # ... existing with config ...
    envs: IMAGE_SHA,COMMIT_SHA,REGISTRY,IMAGE_NAME,DOMAIN,GHCR_TOKEN,GHCR_ACTOR,JWT_SECRET,SESSION_SECRET,NEW_SECRET # Add here
    script: |
      # ...
      cat > .env << 'EOF'
      # ... existing vars ...
      NEW_SECRET=${NEW_SECRET}  # Add here
      EOF
```

### 3. Update Health Check (Optional)

If the secret is required for application functionality, update the health check in `src/app/api/health/route.ts`:

```typescript
function checkSecrets(): HealthCheckResult["checks"]["secrets"] {
  // Add check for new secret
  const hasNewSecret = !!process.env.NEW_SECRET;

  // Include in appropriate category (required or optional)
  return {
    // ... existing code ...
    optional: {
      SESSION_SECRET: hasSessionSecret,
      DOMAIN: hasDomain,
      NEW_SECRET: hasNewSecret, // Add here
    },
    // ... existing code ...
  };
}
```

### 4. Update Documentation

- Add the secret to this document's Required Secrets section
- Update `.env.example` with a comment about the new secret
- Update deployment documentation if needed

### 5. Update Tests

Add tests in `src/__tests__/unit/health-check.test.ts` to verify the new secret is checked properly.

## Reference

- **GitHub Actions Secrets Documentation**: https://docs.github.com/en/actions/security-guides/encrypted-secrets
- **OpenSSL Documentation**: https://www.openssl.org/docs/
- **SSH Key Generation**: https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent

## Support

For issues or questions about secrets management:

1. Check the Troubleshooting section above
2. Review GitHub Actions workflow logs
3. Check server logs: `docker compose logs`
4. Consult the health check endpoint: `/api/health`
